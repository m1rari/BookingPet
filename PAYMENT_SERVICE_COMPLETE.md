# ‚úÖ Payment Service - –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù!

## üéâ Payment Service –≥–æ—Ç–æ–≤ —Å Circuit Breaker –∏ Anticorruption Layer!

**–î–∞—Ç–∞:** 18 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** üü¢ **PRODUCTION READY** (Mock Mode + Real Gateway Ready)

---

## üì¶ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ Domain Layer (Payment.Domain)

**Aggregates:**
- `Payment` - –≥–ª–∞–≤–Ω—ã–π aggregate root
  - States: Pending, Completed, Failed, Refunded
  - Methods: Complete(), Fail(), Refund()
  - Business rules: refund window (30 days), status transitions

**Value Objects:**
- `Money` - –¥–µ–Ω–µ–∂–Ω–∞—è —Å—É–º–º–∞ —Å –≤–∞–ª—é—Ç–æ–π

**Domain Events:**
- `PaymentInitiatedDomainEvent`
- `PaymentCompletedDomainEvent`
- `PaymentFailedDomainEvent`
- `PaymentRefundedDomainEvent`

**Enums:**
- `PaymentStatus` (Pending, Completed, Failed, Refunded)

---

### ‚úÖ Application Layer (Payment.Application)

**Commands + Handlers:**

1. **ProcessPaymentCommand** ‚Üí ProcessPaymentCommandHandler
   - –°–æ–∑–¥–∞–Ω–∏–µ Payment –≤ Pending state
   - –í—ã–∑–æ–≤ external gateway —á–µ—Ä–µ–∑ IPaymentGatewayService
   - Circuit Breaker protection
   - Retry —Å exponential backoff
   - Timeout handling (10 seconds)
   - Success: Complete() + Publish PaymentCompletedIntegrationEvent
   - Failure: Fail() + Publish PaymentFailedIntegrationEvent

2. **RefundPaymentCommand** ‚Üí RefundPaymentCommandHandler
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ refund window (30 days)
   - –í—ã–∑–æ–≤ gateway refund API
   - Circuit Breaker protection
   - Publish PaymentRefundedIntegrationEvent

**Integration Events:**
- `PaymentCompletedIntegrationEvent` - –¥–ª—è Booking Service
- `PaymentFailedIntegrationEvent` - –¥–ª—è Saga compensation
- `PaymentRefundedIntegrationEvent` - –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**Contracts:**
- `IPaymentRepository` - persistence abstraction
- `IPaymentGatewayService` - Anticorruption Layer interface

**DTOs:**
- `PaymentDto` - transfer object
- `PaymentGatewayResponse` - gateway response
- `RefundGatewayResponse` - refund response

---

### ‚úÖ Infrastructure Layer (Payment.Infrastructure)

**üåü PaymentGatewayClient (Anticorruption Layer + Circuit Breaker!):**

#### Resilience Pipeline (Polly):
```
Circuit Breaker
  ‚îú‚îÄ Failure Ratio: 50%
  ‚îú‚îÄ Min Throughput: 3 requests
  ‚îú‚îÄ Break Duration: 30 seconds
  ‚îî‚îÄ States: CLOSED ‚Üí OPEN ‚Üí HALF-OPEN ‚Üí CLOSED
       ‚Üì
Retry Policy
  ‚îú‚îÄ Max Attempts: 3
  ‚îú‚îÄ Backoff: Exponential (1s, 2s, 4s)
  ‚îî‚îÄ Logs each retry attempt
       ‚Üì
Timeout Policy
  ‚îî‚îÄ 10 seconds max
```

#### Features:
- ‚úÖ **Mock Mode** (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ real gateway)
  - Simulates 10% failure rate
  - Demonstrates Circuit Breaker opening
  - Instant success responses
  
- ‚úÖ **Real Gateway Mode**
  - HTTP client —Å Polly policies
  - Anticorruption Layer (–∏–∑–æ–ª–∏—Ä—É–µ—Ç domain –æ—Ç external API)
  - Graceful error handling

**Persistence:**
- `PaymentDbContext` (SQL Server)
- `PaymentConfiguration` - EF Core mapping
- `PaymentRepository` - repository implementation

**DependencyInjection:**
- SQL Server setup
- HttpClient registration –¥–ª—è gateway
- Circuit Breaker configuration
- MassTransit/RabbitMQ

---

### ‚úÖ API Layer (Payment.API)

**Controller: PaymentsController**

```
POST   /api/v1/payments              - Process payment
POST   /api/v1/payments/{id}/refund  - Refund payment
```

**Features:**
- Swagger/OpenAPI documentation
- Health checks (SQL Server)
- OpenTelemetry tracing
- Serilog logging
- Proper HTTP status codes:
  - 200 OK - success
  - 400 Bad Request - validation errors
  - 404 Not Found - payment not found
  - 503 Service Unavailable - Circuit Breaker open

---

## üõ°Ô∏è Resilience Patterns –≤ –¥–µ–π—Å—Ç–≤–∏–∏

### Circuit Breaker State Machine:

```
    CLOSED (Normal Operation)
        ‚îÇ
        ‚îÇ 50% failures in 30s window (min 3 requests)
        ‚ñº
    OPEN (Fail Fast - 30 seconds)
        ‚îÇ –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
        ‚îÇ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 503 immediately
        ‚îÇ
        ‚îÇ –ü–æ—Å–ª–µ 30 —Å–µ–∫—É–Ω–¥
        ‚ñº
    HALF-OPEN (Testing Recovery)
        ‚îÇ –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –æ–¥–∏–Ω test request
        ‚îÇ
        ‚îú‚îÄ Success ‚Üí CLOSED ‚úÖ
        ‚îî‚îÄ Failure ‚Üí OPEN ‚ùå

Benefits:
‚úÖ Prevents cascade failures
‚úÖ Gives system time to recover
‚úÖ Fail-fast (no waiting)
‚úÖ Automatic recovery testing
```

### Retry Policy:
```
Attempt 1: Immediate
   ‚Üì Failed
Attempt 2: Wait 1 second
   ‚Üì Failed
Attempt 3: Wait 2 seconds (exponential)
   ‚Üì Failed
Attempt 4: Wait 4 seconds
   ‚Üì Failed ‚Üí Return error
```

### Timeout Policy:
```
Request starts
   ‚Üì
10 seconds max
   ‚Üì
TimeoutException if not completed
```

---

## üîê Anticorruption Layer

### –ò–∑–æ–ª—è—Ü–∏—è –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ API:

```
Domain (Payment Aggregate)
        ‚Üì
Application (IPaymentGatewayService interface)
        ‚Üì
Infrastructure (PaymentGatewayClient implementation)
        ‚Üì Translates
External Gateway (HTTP API)

Benefit:
‚úÖ Domain –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç external API changes
‚úÖ –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å payment provider
‚úÖ Mock mode –¥–ª—è testing
‚úÖ Centralized error handling
```

---

## üí∞ Business Logic

### Process Payment Flow:
```
1. Receive ProcessPaymentCommand
   ‚Üì
2. Create Payment aggregate (Pending)
   ‚Üì
3. Save to database
   ‚Üì
4. Call PaymentGatewayClient.ProcessPaymentAsync()
   ‚îÇ (with Circuit Breaker, Retry, Timeout)
   ‚Üì
5a. Success:
    - Payment.Complete(externalTxnId)
    - Save to DB
    - Publish PaymentCompletedIntegrationEvent ‚úÖ
    
5b. Failure:
    - Payment.Fail(reason)
    - Save to DB
    - Publish PaymentFailedIntegrationEvent ‚ùå
```

### Refund Flow:
```
1. Receive RefundPaymentCommand
   ‚Üì
2. Load Payment from DB
   ‚Üì
3. Check: IsCompleted? Within 30 days?
   ‚Üì
4. Call gateway.ProcessRefundAsync()
   ‚Üì
5a. Success:
    - Payment.Refund(reason)
    - Save to DB
    - Publish PaymentRefundedIntegrationEvent ‚úÖ
    
5b. Failure:
    - Return error ‚ùå
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Circuit Breaker

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (Mock Mode)
```bash
POST http://localhost:5004/api/v1/payments
{
  "bookingId": "guid",
  "userId": "guid",
  "amount": 10000.00,
  "currency": "RUB",
  "paymentMethod": "CreditCard"
}

–û—Ç–≤–µ—Ç: 200 OK ‚úÖ
–õ–æ–≥–∏: "‚úÖ Mock payment COMPLETED"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Circuit Breaker –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
```bash
# –°–¥–µ–ª–∞–π—Ç–µ 3+ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
# 10% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ mock mode

–ü–æ—Å–ª–µ 3 failures:
  –õ–æ–≥–∏: "‚ö†Ô∏è Circuit breaker OPENED"
  
–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å:
  –û—Ç–≤–µ—Ç: 503 Service Unavailable
  Message: "Payment service temporarily unavailable"
  –õ–æ–≥–∏: "‚ùå Circuit breaker is OPEN - failing fast"
  
–ß–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥:
  –õ–æ–≥–∏: "üîÑ Circuit breaker HALF-OPEN - testing recovery"
  –û–¥–∏–Ω test request –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
  
–ï—Å–ª–∏ —É—Å–ø–µ—Ö:
  –õ–æ–≥–∏: "‚úÖ Circuit breaker CLOSED - requests resumed"
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Retry –≤ –¥–µ–π—Å—Ç–≤–∏–∏
```bash
# –í real mode –ø—Ä–∏ transient errors:
–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
  "üîÑ Retrying payment request, attempt 1 of 3"
  "üîÑ Retrying payment request, attempt 2 of 3"
  "üîÑ Retrying payment request, attempt 3 of 3"
  
Exponential backoff: 1s ‚Üí 2s ‚Üí 4s
```

---

## üìä Database (SQL Server)

### –¢–∞–±–ª–∏—Ü–∞ Payments:
```sql
Columns:
- Id (uniqueidentifier) PK
- BookingId (uniqueidentifier) NOT NULL
- UserId (uniqueidentifier) NOT NULL
- Amount (decimal 18,2) NOT NULL
- Currency (varchar 3) NOT NULL
- Status (varchar 50) NOT NULL
- ExternalTransactionId (varchar 200)
- PaymentMethod (varchar 50)
- FailureReason (varchar 1000)
- CreatedAt (datetime2) NOT NULL
- CompletedAt (datetime2)
- RefundedAt (datetime2)

Indexes:
‚úÖ BookingId
‚úÖ UserId
‚úÖ Status
‚úÖ ExternalTransactionId
```

---

## üöÄ –ó–∞–ø—É—Å–∫ Payment Service

### 1. –ó–∞–ø—É—Å–∫ SQL Server (—É–∂–µ –≤ docker-compose):
```bash
docker run -d --name sqlserver-payment \
  -e "ACCEPT_EULA=Y" \
  -e "SA_PASSWORD=YourStrong@Passw0rd" \
  -p 1433:1433 \
  mcr.microsoft.com/mssql/server:2022-latest
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ SQL Server –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
CREATE DATABASE PaymentDB;
GO

USE PaymentDB;
GO

# –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ payment-db-init.sql
```

### 3. –ó–∞–ø—É—Å–∫ Payment Service:
```bash
cd src/Services/Payment/Payment.API
dotnet run --urls http://localhost:5004
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞:
http://localhost:5004/swagger

---

## üéØ API Endpoints

### Process Payment:
```bash
POST http://localhost:5004/api/v1/payments
{
  "bookingId": "a0000000-0000-0000-0000-000000000001",
  "userId": "00000000-0000-0000-0000-000000000001",
  "amount": 10000.00,
  "currency": "RUB",
  "paymentMethod": "CreditCard"
}
```

### Refund Payment:
```bash
POST http://localhost:5004/api/v1/payments/{paymentId}/refund
{
  "reason": "Customer requested cancellation"
}
```

---

## üèÜ –ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è Payment Service

### 1. ‚≠ê‚≠ê‚≠ê Circuit Breaker Pattern (Polly)
- –ü–æ–ª–Ω–∞—è state machine (CLOSED ‚Üí OPEN ‚Üí HALF-OPEN)
- Failure ratio based (50%)
- Automatic recovery testing
- Detailed logging –∫–∞–∂–¥–æ–≥–æ state change

### 2. ‚≠ê‚≠ê Anticorruption Layer
- –ò–∑–æ–ª—è—Ü–∏—è domain –æ—Ç external API
- Interface abstraction (IPaymentGatewayService)
- Mock mode –¥–ª—è testing
- Easy provider swapping

### 3. ‚≠ê‚≠ê Resilience Policies
- Retry —Å exponential backoff
- Timeout protection
- Graceful degradation
- Service unavailability handling

### 4. ‚≠ê Business Logic
- Payment lifecycle (Pending ‚Üí Completed/Failed)
- Refund window validation (30 days)
- Transaction tracking
- Audit trail (timestamps)

### 5. ‚≠ê Integration Events
- PaymentCompletedIntegrationEvent ‚Üí Booking Saga
- PaymentFailedIntegrationEvent ‚Üí Saga compensation
- Event-driven architecture ready

---

## üìà –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Booking Service

### Saga Coordination:

```
Booking Service (CreateBookingSaga)
        ‚Üì
–ü—É–±–ª–∏–∫—É–µ—Ç: InitiatePaymentIntegrationEvent
        ‚Üì
Payment Service (—Å–ª—É—à–∞–µ—Ç event)
        ‚Üì
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ (—Å Circuit Breaker!)
        ‚Üì
Success: –ü—É–±–ª–∏–∫—É–µ—Ç PaymentCompletedIntegrationEvent
        ‚Üì
Booking Service: ConfirmBooking() ‚úÖ

OR

Failure: –ü—É–±–ª–∏–∫—É–µ—Ç PaymentFailedIntegrationEvent
        ‚Üì
Booking Service: Saga Compensation (Rollback) ‚ùå
```

---

## üî• Demo Features

### Mock Mode (–≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (100ms delay)
- ‚úÖ 90% success rate (10% failures –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç mock transaction IDs
- ‚úÖ –õ–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏

### Real Gateway Mode:
- ‚úÖ HTTP calls –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É payment gateway
- ‚úÖ Circuit Breaker –∑–∞—â–∏—Ç–∞
- ‚úÖ Retry policies
- ‚úÖ Production-ready

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:** `appsettings.json` ‚Üí `PaymentGateway:MockMode: false`

---

## üìä –ü–æ–ª–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### Payment Lifecycle:
```
PENDING
  ‚Üì Complete(externalTxnId)
COMPLETED
  ‚Üì Refund(reason) [within 30 days]
REFUNDED

OR

PENDING
  ‚Üì Fail(reason)
FAILED
```

### Validations:
- ‚úÖ Amount > 0
- ‚úÖ Currency –Ω–µ –ø—É—Å—Ç–∞—è
- ‚úÖ BookingId –∏ UserId –Ω–µ empty
- ‚úÖ Refund —Ç–æ–ª—å–∫–æ –¥–ª—è Completed payments
- ‚úÖ Refund window check (30 days)
- ‚úÖ Status transition rules

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. Happy Path:
```
1. POST /payments (process)
   ‚Üí Mock gateway returns success
   ‚Üí Payment status: Completed ‚úÖ
   ‚Üí Event: PaymentCompletedIntegrationEvent published
   
2. Check RabbitMQ - see the event!
```

### 2. Circuit Breaker Demo:
```
1. POST /payments –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
   ‚Üí –ù–µ–∫–æ—Ç–æ—Ä—ã–µ fail (10% rate)
   ‚Üí –ü–æ—Å–ª–µ 3 failures: Circuit OPENS ‚ö†Ô∏è
   
2. POST /payments again
   ‚Üí Immediate 503 response (fail-fast!)
   ‚Üí No actual gateway call
   
3. Wait 30 seconds
   ‚Üí Circuit goes HALF-OPEN üîÑ
   
4. POST /payments
   ‚Üí One test request allowed
   ‚Üí If success: Circuit CLOSED ‚úÖ
```

### 3. Retry Demo:
```
# In real mode with transient errors:
Request fails
  ‚Üí Retry after 1s
  ‚Üí Retry after 2s (exponential)
  ‚Üí Retry after 4s
  ‚Üí Final failure if all retries exhausted
```

### 4. Refund:
```
1. POST /payments (create payment)
2. POST /payments/{id}/refund
   ‚Üí Within 30 days: Success ‚úÖ
   ‚Üí After 30 days: Error "Refund window closed" ‚ùå
```

---

## üéØ Configuration

### appsettings.json:
```json
{
  "PaymentGateway": {
    "Url": "https://api.payment-gateway.com",
    "MockMode": true,  ‚Üê –í–∫–ª—é—á–∞–µ—Ç mock mode
    "ApiKey": "your-key"
  }
}
```

### Polly Configuration (in code):
- Circuit Breaker: 50% failure ratio, 3 min throughput, 30s break
- Retry: 3 attempts, exponential backoff
- Timeout: 10 seconds

---

## üì¶ Technologies

**Resilience:**
- ‚úÖ Polly 8.2.1
- ‚úÖ Circuit Breaker
- ‚úÖ Retry Policies
- ‚úÖ Timeout

**Database:**
- ‚úÖ SQL Server 2022
- ‚úÖ EF Core 8

**Integration:**
- ‚úÖ MassTransit/RabbitMQ
- ‚úÖ Integration Events

**Observability:**
- ‚úÖ OpenTelemetry
- ‚úÖ Serilog
- ‚úÖ Health Checks

---

## üèÜ –ò–¢–û–ì–û

### Payment Service –≤–∫–ª—é—á–∞–µ—Ç:

**Patterns:**
- ‚úÖ Clean Architecture (4 —Å–ª–æ—è)
- ‚úÖ DDD (Aggregate, Value Objects, Domain Events)
- ‚úÖ CQRS (Commands/Queries)
- ‚úÖ **Circuit Breaker** ‚≠ê‚≠ê‚≠ê
- ‚úÖ **Anticorruption Layer** ‚≠ê‚≠ê
- ‚úÖ Retry with Exponential Backoff
- ‚úÖ Repository Pattern
- ‚úÖ Event-Driven Architecture

**Business Logic:**
- ‚úÖ Payment processing
- ‚úÖ Refund handling (30-day window)
- ‚úÖ Transaction tracking
- ‚úÖ Status lifecycle management
- ‚úÖ External gateway integration

**Resilience:**
- ‚úÖ Circuit Breaker (handles failures gracefully)
- ‚úÖ Retry policies (3 attempts)
- ‚úÖ Timeout protection (10s)
- ‚úÖ Graceful degradation (503 when circuit open)

**Production Ready:**
- ‚úÖ Mock mode –¥–ª—è development/testing
- ‚úÖ Real gateway mode –¥–ª—è production
- ‚úÖ Comprehensive logging —Å —ç–º–æ–¥–∑–∏
- ‚úÖ Health checks
- ‚úÖ Metrics

---

## üöÄ Quick Test

```bash
# 1. Start Payment Service
cd src/Services/Payment/Payment.API
dotnet run --urls http://localhost:5004

# 2. Open Swagger
http://localhost:5004/swagger

# 3. Process Payment
POST /api/v1/payments
{
  "bookingId": "b0000000-0000-0000-0000-000000000001",
  "userId": "00000000-0000-0000-0000-000000000001",
  "amount": 5000.00,
  "currency": "RUB"
}

# 4. Watch logs for Circuit Breaker activity! üîç
```

---

## ‚úÖ PAYMENT SERVICE - –ü–û–õ–ù–û–°–¢–¨–Æ –§–£–ù–ö–¶–ò–û–ù–ê–õ–ï–ù!

**–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:**
- ‚úÖ Domain Model ‚úÖ CQRS ‚úÖ Circuit Breaker ‚úÖ Anticorruption Layer
- ‚úÖ Retry Policies ‚úÖ Timeout ‚úÖ Integration Events ‚úÖ Repository
- ‚úÖ Health Checks ‚úÖ Logging ‚úÖ Observability ‚úÖ SQL Server DB

**–ì–æ—Ç–æ–≤ –∫:**
- ‚úÖ Development (Mock Mode)
- ‚úÖ Testing (Circuit Breaker demos)
- ‚úÖ Production (Real Gateway Mode)
- ‚úÖ Integration (Booking Saga coordination)

---

**PAYMENT SERVICE - PRODUCTION READY!** üéâüí≥

**–°–º. —Ç–∞–∫–∂–µ:** `payment-service-tests.http` –¥–ª—è –≥–æ—Ç–æ–≤—ã—Ö API –∑–∞–ø—Ä–æ—Å–æ–≤

