# –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ç–µ–∫—É—â–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
- –ò–∑—É—á–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã BuildingBlocks.Authentication
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 2. ‚úÖ –°–æ–∑–¥–∞–Ω IdentityServer –ø—Ä–æ–µ–∫—Ç –¥–ª—è Client Credentials
- **–ü—Ä–æ–µ–∫—Ç**: `src/IdentityServer/`
- **–ü–∞–∫–µ—Ç—ã**: Duende.IdentityServer 7.3.2
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: 
  - API Scopes –¥–ª—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
  - Clients –¥–ª—è Gateway –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
  - Dockerfile –∏ docker-compose –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- **–ü–æ—Ä—Ç**: 5005 (HTTPS)

### 3. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω API Gateway –¥–ª—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ü–∞–∫–µ—Ç—ã**: IdentityModel 7.0.0
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**:
  - `TokenService` - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Client Credentials —Ç–æ–∫–µ–Ω–æ–≤
  - `ServiceTokenDelegatingHandler` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: Ocelot —Å DelegatingHandler
- **–ü–æ—Ä—Ç**: 5000 (HTTPS)

### 4. ‚úÖ –ó–∞—â–∏—â–µ–Ω—ã –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã Client Credentials
- **Booking Service** (5001): `bookings.api` scope
- **Inventory Service** (5002): `inventory.api` scope  
- **Payment Service** (5003): `payments.api` scope
- **–ü–∞–∫–µ—Ç—ã**: Microsoft.AspNetCore.Authentication.JwtBearer 8.0.11
- **–ü–æ–ª–∏—Ç–∏–∫–∏**: `ApiScope` –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

### 5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω UserService –¥–ª—è –¥–≤–æ–π–Ω–æ–π —Ä–æ–ª–∏
- **–î–≤–æ–π–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**:
  - `UserJWT` —Å—Ö–µ–º–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
  - `Bearer` —Å—Ö–µ–º–∞ –¥–ª—è Client Credentials
- **–ü–æ–ª–∏—Ç–∏–∫–∏**:
  - `UserAuth` –¥–ª—è `/me` endpoint
  - `ApiScope` –¥–ª—è service-to-service –≤—ã–∑–æ–≤–æ–≤
- **Endpoints**:
  - `/login`, `/register` - –±–µ–∑ Client Credentials
  - –û—Å—Ç–∞–ª—å–Ω—ã–µ endpoints - —Å Client Credentials

### 6. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–¢–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã**: `dual-auth-tests.http`
- **–°–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞**: 
  - `start-dual-auth.sh` (Linux/macOS)
  - `start-dual-auth.ps1` (Windows)
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `DUAL_AUTH_ARCHITECTURE.md`

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   API Gateway   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã   ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ JWT Token       ‚îÇ    ‚îÇ User JWT Check  ‚îÇ    ‚îÇ Client Creds    ‚îÇ
‚îÇ (User Auth)     ‚îÇ    ‚îÇ + Service Token ‚îÇ    ‚îÇ (Service Auth)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                       ‚îÇ IdentityServer  ‚îÇ
                       ‚îÇ                 ‚îÇ
                       ‚îÇ Client Creds    ‚îÇ
                       ‚îÇ Token Issuer    ‚îÇ
                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí **Gateway** (—Å JWT) ‚Üí **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å** (—Å Client Credentials)
2. **Gateway** ‚Üí **IdentityServer** (Client Credentials) ‚Üí **Service Token**
3. **Gateway** ‚Üí **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å** (—Å Service Token)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **Defence in Depth** - –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
- **–ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤** - –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –±–µ–∑ Client Credentials
- **–ì—Ä–∞–Ω—É–ª—è—Ä–Ω—ã–µ –ø—Ä–∞–≤–∞** - –†–∞–∑–Ω—ã–µ scope –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤** - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
- **Development**: `RequireHttpsMetadata = false`
- **Production**: `RequireHttpsMetadata = true` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- **–°–µ–∫—Ä–µ—Ç—ã**: –•—Ä–∞–Ω–∏—Ç—å –≤ Azure Key Vault/AWS Secrets Manager/Kubernetes Secrets

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### IdentityServer:
- `src/IdentityServer/Config.cs` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API Scopes –∏ Clients
- `src/IdentityServer/Program.cs` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IdentityServer
- `src/IdentityServer/Dockerfile` - Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
- `src/IdentityServer/appsettings.json` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### API Gateway:
- `src/ApiGateway/ApiGateway.Ocelot/Services/ITokenService.cs` - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤
- `src/ApiGateway/ApiGateway.Ocelot/Services/TokenService.cs` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤
- `src/ApiGateway/ApiGateway.Ocelot/Handlers/ServiceTokenDelegatingHandler.cs` - Handler –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- `dual-auth-tests.http` - HTTP —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- `start-dual-auth.sh` - –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ (Linux/macOS)
- `start-dual-auth.ps1` - –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ (Windows)

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- `DUAL_AUTH_ARCHITECTURE.md` - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### Windows:
```powershell
.\start-dual-auth.ps1
```

### Linux/macOS:
```bash
chmod +x start-dual-auth.sh
./start-dual-auth.sh
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ Client Credentials —Ç–æ–∫–µ–Ω–∞:
```http
POST https://localhost:5005/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id=api-gateway&client_secret=gateway-secret-key&scope=inventory.api bookings.api users.api payments.api
```

### 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:
```http
POST https://localhost:5000/api/v1/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password"
}
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö endpoints:
```http
GET https://localhost:5001/api/v1/bookings
Authorization: Bearer <service-token>
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **Jaeger UI**: http://localhost:16686
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000 (admin/admin)
- **RabbitMQ UI**: http://localhost:15672 (guest/guest)

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è:

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - Defence in depth —Å –∏–∑–æ–ª—è—Ü–∏–µ–π —Å–µ—Ä–≤–∏—Å–æ–≤
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. **–ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å** - –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
5. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ì–æ—Ç–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∏ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
